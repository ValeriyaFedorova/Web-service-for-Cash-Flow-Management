{% extends 'transactions/base.html' %}
{% load static %}

{% block title %}Список транзакций - Управление ДДС{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-list-ul"></i> Движение денежных средств</h1>
    <a href="{% url 'transaction_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Добавить запись
    </a>
</div>

<!-- Фильтры -->
{% include 'transactions/includes/filters.html' %}

<!-- Статистика -->
{% include 'transactions/includes/statistics.html' %}

<!-- Таблица транзакций -->
{% if transactions %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Дата</th>
                <th>Статус</th>
                <th>Тип</th>
                <th>Категория</th>
                <th>Подкатегория</th>
                <th>Сумма</th>
                <th>Комментарий</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr class="align-middle">
                <td>{{ transaction.created_date|date:"d.m.Y" }}</td>
                <td>
                    <span class="badge 
                        {% if transaction.status.name == 'Бизнес' %}bg-primary
                        {% elif transaction.status.name == 'Личное' %}bg-success
                        {% elif transaction.status.name == 'Налог' %}bg-warning
                        {% else %}bg-secondary{% endif %}">
                        {{ transaction.status }}
                    </span>
                </td>
                <td>
                    <span class="badge 
                        {% if transaction.type.name == 'Пополнение' %}bg-success
                        {% elif transaction.type.name == 'Списание' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ transaction.type }}
                    </span>
                </td>
                <td>{{ transaction.category }}</td>
                <td>{{ transaction.subcategory }}</td>
                <td>
                    <span class="{% if transaction.type.name == 'Пополнение' %}amount-positive{% else %}amount-negative{% endif %}">
                        {{ transaction.amount }} ₽
                    </span>
                </td>
                <td>
                    {% if transaction.comment %}
                    <span data-bs-toggle="tooltip" title="{{ transaction.comment }}">
                        <i class="bi bi-chat-text"></i>
                    </span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'transaction_edit' transaction.pk %}" 
                           class="btn btn-outline-primary" 
                           data-bs-toggle="tooltip" title="Редактировать">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'transaction_delete' transaction.pk %}" 
                           class="btn btn-outline-danger" 
                           data-bs-toggle="tooltip" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Пагинация -->
{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% for key, value in filter_params.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Первая</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in filter_params.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Назад</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
                <a class="page-link" href="?page={{ num }}{% for key, value in filter_params.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
            </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% for key, value in filter_params.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in filter_params.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Вперед</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in filter_params.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Последняя</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h3 class="text-muted">Нет записей</h3>
    <p class="text-muted">Начните с добавления первой записи о движении денежных средств</p>
    <a href="{% url 'transaction_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Добавить первую запись
    </a>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Активация подсказок
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // // Подтверждение удаления
    // const deleteButtons = document.querySelectorAll('.btn-delete');
    // deleteButtons.forEach(function(button) {
    //     button.addEventListener('click', function(e) {
    //         if (!confirm('Вы уверены, что хотите удалить эту запись?')) {
    //             e.preventDefault();
    //         }
    //     });
    // });
});
</script>
{% endblock %}